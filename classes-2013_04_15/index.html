<html>
<head>
<title></title>
<script src='../lib/gl-matrix.js'></script>
<script src='../lib/utils.js'></script>
<script src='../lib/ShaderLoader.js'></script>
<script src='../lib/Shader.js'></script>
<script src='Material.js'></script>
<script src='Plane.js'></script>
<script src='Light.js'></script>
</head>
<body style="margin:0">
<canvas id='canvas'></canvas>
<script>
var canvas = document.getElementById('canvas');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
window.gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
gl.enable(gl.DEPTH_TEST);
gl.clearColor(0.0, 0.0, 0.0, 1.0);
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

var preProgram = gl.createProgram();
var preShader = new Shader(preProgram, 'pre.vert', 'pre.frag');

var modelViewMatrix = mat4.create();
var projectionMatrix = mat4.create();
var normalMatrix = mat3.create();
var lightMatrix = mat4.create();

var light = new Light();
var geometry = new Plane(10, 10, 10, 10);
console.log(geometry.vertices);
console.log(geometry.indices);
var vertexBuffer = gl.createBuffer();
var indexBuffer = gl.createBuffer();

var texture;
function initTexture(img){
  texture = gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D, texture);
  gl.texParameterf(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
  gl.texParameterf(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
  gl.texParameterf(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
  gl.texParameterf(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
  gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
  gl.bindTexture(gl.TEXTURE_2D, null);
}

function initBuffers(){
  gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(geometry.vertices), gl.STATIC_DRAW);

  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
  gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(geometry.indices), gl.STATIC_DRAW);
}

var image = createImage('../img/block.png', init)
function init(){
  initTexture(image);
  initBuffers();

  // link program
  gl.useProgram(preProgram);
  preShader.bindAttributes(preProgram);
  preShader.bindUniforms(preProgram);

  function render(){
    preRendering();

    requestAnimFrame(render);
  }
  requestAnimFrame(render);
}

var rotationX = 0;
var rotationY = 0;
function preRendering(){
  gl.clear(gl.DEPTH_BUFFER_BIT | gl.COLOR_BUFFER_BIT);

  gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
  gl.bindTexture(gl.TEXTURE_2D, texture);

  // enable vertex pointer ect.
  gl.vertexAttribPointer(preShader.attribute.a_Vertex, 3, gl.FLOAT, false, 48, 0);
  gl.vertexAttribPointer(preShader.attribute.a_TexCoord, 2, gl.FLOAT, false, 48, 12);
  gl.vertexAttribPointer(preShader.attribute.a_Normal, 3, gl.FLOAT, false, 48, 20);
  gl.vertexAttribPointer(preShader.attribute.a_Color, 4, gl.FLOAT, false, 48, 32);
  gl.enableVertexAttribArray(preShader.attribute.a_Vertex);
  gl.enableVertexAttribArray(preShader.attribute.a_TexCoord);
  gl.enableVertexAttribArray(preShader.attribute.a_Normal);
  gl.enableVertexAttribArray(preShader.attribute.a_Color);

  rotationX += 0.02;
  rotationY -= 0.003;
  mat4.identity(modelViewMatrix);
  mat4.translate(modelViewMatrix, modelViewMatrix, [0, 0, -9]);
  mat4.rotate(modelViewMatrix, modelViewMatrix, rotationX, [1, 0, 0]);
  mat4.rotate(modelViewMatrix, modelViewMatrix, rotationY, [0, 1, 0]);
  mat4.perspective(projectionMatrix, Math.PI/3, canvas.width/canvas.height, 0.1, 400);
  gl.uniformMatrix4fv(preShader.uniform['u_ProjectionMatrix'], false, projectionMatrix);
  gl.uniformMatrix4fv(preShader.uniform['u_ModelViewMatrix'], false, modelViewMatrix);

  // light
  gl.uniform4fv(preShader.uniform['u_Light.position'], light.position);
  gl.uniform4fv(preShader.uniform['u_Light.ambient'], [0.05, 0.05, 0.05, 1.0]);
  gl.uniform4fv(preShader.uniform['u_Light.diffuse'], [0.4, 0.4, 0.4, 1.0]);
  gl.uniform4fv(preShader.uniform['u_Light.specular'], [1.0, 1.0, 1.0, 1.0]);
  gl.uniform1f(preShader.uniform['u_Light.attenuationConstant'], 1);
  gl.uniform1f(preShader.uniform['u_Light.attenuationLinear'], 0);
  gl.uniform1f(preShader.uniform['u_Light.attenuationQuadratic'], 0);
  gl.uniform3fv(preShader.uniform['u_Light.spotDirection'], [0, 0.5, 0.5]);
  gl.uniform1f(preShader.uniform['u_Light.cosOuter'], Math.cos(Math.PI/3));
  gl.uniform1f(preShader.uniform['u_Light.cosFalloff'], Math.cos(Math.PI/3) - Math.cos(Math.PI/6));
  // material
  gl.uniform4fv(preShader.uniform['u_Material.ambient'], [1.0, 1.0, 1.0, 1.0]);
  gl.uniform4fv(preShader.uniform['u_Material.diffuse'], [1.0, 1.0, 1.0, 1.0]);
  gl.uniform4fv(preShader.uniform['u_Material.specular'], [1.0, 1.0, 1.0, 1.0]);
  gl.uniform4fv(preShader.uniform['u_Material.emission'], [0.0, 0.0, 0.0, 1.0]);
  gl.uniform1f(preShader.uniform['u_Material.shininess'], 50);

  // transform model normal
  mat3.normalFromMat4(normalMatrix, modelViewMatrix);
  gl.uniformMatrix3fv(preShader.uniform['u_NormalMatrix'], false, normalMatrix);

  // console.log(this.geometry.indices.length);
  gl.drawElements(gl.TRIANGLES, this.geometry.indices.length, gl.UNSIGNED_SHORT, 0);
}

</script>
</body>
</html>